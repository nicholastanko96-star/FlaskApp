name: CI Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  IMAGE_NAME: flaskapp

jobs:

  # -------------------- JOB 1 : TESTS --------------------
  tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: pytest


  # -------------------- JOB 2 : BUILD DOCKER IMAGE --------------------
  build:
    runs-on: ubuntu-latest
    needs: tests                # must wait for tests to complete
    if: ${{ needs.tests.result == 'success' }}   # only run if tests pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: docker build -t flaskapp-ci .


  # -------------------- JOB 3 : PUSH TO DOCKER HUB + GHCR --------------------
  push-image:
    runs-on: ubuntu-latest
    needs: [tests, build]
    if: ${{ needs.tests.result == 'success' }}   # only push if tests passed

    steps:
    - name: Checkout code
      uses: actions/checkout@v3


    # ----- Docker Hub Login -----
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}


    # ----- GHCR Login (Private Registry) -----
    - name: Log in to GHCR
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.PRIVATE_REGISTRY_URL }}   # ghcr.io
        username: ${{ secrets.PRIVATE_REGISTRY_USER }}   # your GitHub username
        password: ${{ secrets.PRIVATE_REGISTRY_PASS }}   # PAT with write:packages


    # ----- Tag and Push to Registries -----
    - name: Tag and push images
      run: |
        # Push to Docker Hub
        docker tag flaskapp-ci ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

        # Push to GitHub Container Registry (GHCR)
        docker tag flaskapp-ci ghcr.io/${{ secrets.PRIVATE_REGISTRY_USER }}/${{ env.IMAGE_NAME }}:latest
        docker push ghcr.io/${{ secrets.PRIVATE_REGISTRY_USER }}/${{ env.IMAGE_NAME }}:latest


  # -------------------- JOB 4 : SEND EMAIL IF TESTS FAIL --------------------
  notify:
    runs-on: ubuntu-latest
    needs: tests
    if: ${{ needs.tests.result == 'failure' }}

    steps:
    - name: Send email alert about failed tests
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        from: ${{ secrets.EMAIL_FROM }}
        to: ${{ secrets.EMAIL_TO }}
        subject: "‚ùå CI Pipeline Failed - Tests Did Not Pass"
        body: |
          The test suite failed in the CI pipeline.
          Repository: ${{ github.repository }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}

          Please check the GitHub Actions logs for more details.




