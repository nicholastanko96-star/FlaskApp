name: CI Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  IMAGE_NAME: flaskapp

jobs:

  # -------------------- JOB 1 : TESTS --------------------
  tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: pytest


  # -------------------- JOB 2 : BUILD DOCKER IMAGE --------------------
  build:
    runs-on: ubuntu-latest
    needs: tests
    if: ${{ needs.tests.result == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: docker build -t flaskapp-ci:latest .


  # -------------------- JOB 3 : PUSH TO DOCKER HUB + GHCR --------------------
  push-image:
    runs-on: ubuntu-latest
    needs: [tests, build]
    if: ${{ needs.tests.result == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Build image again (images do NOT persist across jobs)
    - name: Build Docker image again for pushing
      run: docker build -t flaskapp-ci:latest .

    # Docker Hub login
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # GHCR login
    - name: Log in to GHCR
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.PRIVATE_REGISTRY_URL }}
        username: ${{ secrets.PRIVATE_REGISTRY_USER }}
        password: ${{ secrets.PRIVATE_REGISTRY_PASS }}

    # Push to registries
    - name: Tag and push images
      run: |
        # Push to Docker Hub
        docker tag flaskapp-ci:latest ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

        # Push to GitHub Container Registry (GHCR)
        docker tag flaskapp-ci:latest ghcr.io/${{ secrets.PRIVATE_REGISTRY_USER }}/${{ env.IMAGE_NAME }}:latest
        docker push ghcr.io/${{ secrets.PRIVATE_REGISTRY_USER }}/${{ env.IMAGE_NAME }}:latest


  # -------------------- JOB 4 : SEND EMAIL IF TESTS FAIL --------------------
      notify:
    runs-on: ubuntu-latest
    needs: tests
    if: ${{ always() && needs.tests.result == 'failure' }}

    steps:
    - name: Send email alert about failed tests
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        from: ${{ secrets.EMAIL_FROM }}
        to: ${{ secrets.EMAIL_TO }}
        subject: "‚ùå CI Pipeline - Test Failure Notification"
        body: |
          Your CI pipeline tests have failed.
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Please check the GitHub Actions logs for more details.

