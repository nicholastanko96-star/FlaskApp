name: CI Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  IMAGE_NAME: flaskapp

# ------------------ JOB 1 : TESTS ------------------
jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: pytest


  # ------------------ JOB 2 : BUILD IMAGE ------------------
  build:
    runs-on: ubuntu-latest
    needs: tests      # ensures tests run BEFORE build
    if: ${{ needs.tests.result == 'success' }}    # <- build only if tests pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: docker build -t flaskapp-ci .

  # ------------------ JOB 3 : PUSH IMAGE TO 2 REGISTRIES ------------------
  push-image:
    runs-on: ubuntu-latest
    needs: [ tests, build ]
    if: ${{ needs.tests.result == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Docker Hub login
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Private registry login
    - name: Log in to private registry
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.PRIVATE_REGISTRY_URL }}
        username: ${{ secrets.PRIVATE_REGISTRY_USER }}
        password: ${{ secrets.PRIVATE_REGISTRY_PASS }}

    - name: Tag and push Docker images
      run: |
        # Push to Docker Hub
        docker tag flaskapp-ci ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

        # Push to Private registry
        docker tag flaskapp-ci ${{ secrets.PRIVATE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.PRIVATE_REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest

  # ------------------ JOB 4 : EMAIL NOTIFICATION IF TEST FAIL ------------------
  notify:
    runs-on: ubuntu-latest
    needs: tests
    if: ${{ needs.tests.result == 'failure' }}

    steps:
    - name: Send email notification about failed tests
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        from: ${{ secrets.EMAIL_FROM }}
        to: ${{ secrets.EMAIL_TO }}
        subject: "âŒ CI Tests Failed - FlaskApp"
        body: "The tests have failed. Please check the GitHub Actions logs."



